<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Analytics - Handloom Weavers Nexus</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/pages.css">
    <script src="/js/chart.umd.js"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2.5rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            border: 1px solid #f0f0f0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
            min-height: 400px;
        }

        .stats-tile {
            background: white;
            padding: 2rem;
            border-radius: 24px;
            border: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stats-tile .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-dark);
            letter-spacing: -1px;
        }

        .activity-card {
            padding: 1.25rem;
            border-radius: 16px;
            background: #fafafa;
            border: 1px solid #eee;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="app-shell">
        <div id="header-placeholder"></div>
        <div id="sidebar-placeholder"></div>
        <main class="main-content">
            <div class="container" style="padding: 2rem 1rem;">
                <div style="margin-bottom: 3.5rem;">
                    <h1
                        style="font-family: var(--font-heading); font-size: 3.5rem; margin: 0; color: var(--color-dark); letter-spacing: -2px;">
                        Platform Insights</h1>
                    <p style="color: #888; font-size: 1.1rem; margin-top: 0.5rem;">Visualizing growth, artisan success,
                        and marketplace trends.</p>
                </div>

                <div id="loading-state" style="text-align: center; padding: 6rem;">
                    <div class="loader" style="margin: 0 auto;"></div>
                </div>

                <div id="analytics-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-bottom: 3rem;">
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Total
                                GMV</span>
                            <div class="value" id="stats-revenue">₹0</div>
                        </div>
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Active
                                Artisans</span>
                            <div class="value" id="stats-weavers">0</div>
                        </div>
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Collection
                                Size</span>
                            <div class="value" id="stats-sarees">0</div>
                        </div>
                    </div>

                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 2rem;">
                                Revenue by Category</h3>
                            <canvas id="category-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 2rem;">Recent
                                Activity</h3>
                            <div id="recent-activity-list"></div>
                        </div>
                    </div>

                    <div style="margin-top: 3rem;">
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 2rem;">Top
                                Performing Artisans</h3>
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="top-weavers-table">
                                    <thead>
                                        <tr>
                                            <th>Artisan</th>
                                            <th>Region</th>
                                            <th>Total Sales</th>
                                            <th>Revenue</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-weavers-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="footer-placeholder" style="margin-top: 5rem;"></div>
            </div>
        </main>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/components.js"></script>
    <script>
        (async function () {
            const user = await auth.checkAuth();
            if (!user || user.role !== 'admin') {
                window.location.href = '/pages/login.html';
                return;
            }

            try {
                const response = await api.get('/api/admin/analytics');
                const data = response.data;

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';

                // Update Stats
                const totalRevenue = data.categoryBreakdown.reduce((sum, item) => sum + parseFloat(item.revenue), 0);
                const totalSarees = data.categoryBreakdown.reduce((sum, item) => sum + parseInt(item.saree_count), 0);
                document.getElementById('stats-revenue').textContent = `₹${totalRevenue.toLocaleString()}`;
                document.getElementById('stats-weavers').textContent = data.topWeavers.length;
                document.getElementById('stats-sarees').textContent = totalSarees;

                // Category Chart
                const ctx = document.getElementById('category-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.categoryBreakdown.map(c => c.name),
                        datasets: [{
                            data: data.categoryBreakdown.map(c => c.revenue),
                            backgroundColor: ['#C0392B', '#B8860B', '#2C3E50', '#7F8C8D', '#E67E22', '#16A085'],
                            borderWidth: 0,
                            hoverOffset: 20
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 25, usePointStyle: true, font: { family: 'Poppins', size: 12 } } }
                        },
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Recent Activity
                const activityList = document.getElementById('recent-activity-list');
                activityList.innerHTML = (data.recentActivity || []).map(act => `
                    <div class="activity-card">
                        <div>
                            <div style="font-weight: 700; color: var(--color-dark);">#${act.id} by ${act.buyer_name}</div>
                            <div style="font-size: 0.85rem; color: #999;">${new Date(act.created_at).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 800; color: var(--color-primary);">₹${parseFloat(act.total_amount).toLocaleString()}</div>
                            <span class="status-badge status-${act.status}">${act.status}</span>
                        </div>
                    </div>
                `).join('') || '<p style="color: #999; text-align: center; padding: 2rem;">No recent orders</p>';

                // Top Weavers
                const weaversBody = document.getElementById('top-weavers-body');
                weaversBody.innerHTML = (data.topWeavers || []).slice(0, 5).map(w => `
                    <tr>
                        <td style="font-weight: 700;">${w.name}</td>
                        <td>${w.region || 'Unknown'}</td>
                        <td>${w.order_count} Orders</td>
                        <td style="font-weight: 800; color: var(--color-primary);">₹${parseFloat(w.total_earnings).toLocaleString()}</td>
                        <td><button class="btn btn-secondary btn-sm" onclick="window.location.href='/pages/admin-users.html?id=${w.id}'">View Detail</button></td>
                    </tr>
                `).join('');

            } catch (err) {
                notifications.showToast('error', 'Sync Failed', 'Unable to retrieve marketplace intelligence.');
                console.error(err);
            }
        })();
    </script>
</body>

</html>
