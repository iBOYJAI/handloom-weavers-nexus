<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Analytics - Handloom Weavers Nexus</title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/pages.css">
    <script src="/js/chart.umd.js"></script>
    <style>
        /* Use full width of main content area (fix overflow/narrow strip on right) */
        .page-analytics .container {
            width: 100%;
            max-width: none;
            padding-left: var(--spacing-2xl);
            padding-right: var(--spacing-2xl);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2.5rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid #f0f0f0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
            height: 450px;
            /* Fixed height to prevent automatic expansion */
            display: flex;
            flex-direction: column;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
            /* Critical for Chart.js in flexbox */
        }

        .activity-list-scroll {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .activity-list-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .activity-list-scroll::-webkit-scrollbar-thumb {
            background: #eee;
            border-radius: 10px;
        }

        .stats-tile {
            background: white;
            padding: 2rem;
            border-radius: 24px;
            border: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stats-tile .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-dark);
            letter-spacing: -1px;
        }

        .activity-card {
            padding: 1.25rem;
            border-radius: 16px;
            background: #fafafa;
            border: 1px solid #eee;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="app-shell">
        <div id="header-placeholder"></div>
        <div id="sidebar-placeholder"></div>
        <main class="main-content page-analytics">
            <div class="container" style="padding: 2rem 0;">
                <div style="margin-bottom: 3.5rem;">
                    <h1
                        style="font-family: var(--font-heading); font-size: 3.5rem; margin: 0; color: var(--color-dark); letter-spacing: -2px;">
                        Platform Insights</h1>
                    <p style="color: #888; font-size: 1.1rem; margin-top: 0.5rem;">Visualizing growth, artisan success,
                        and marketplace trends.</p>
                </div>

                <div id="loading-state" style="text-align: center; padding: 6rem;">
                    <div class="loader" style="margin: 0 auto;"></div>
                </div>

                <div id="analytics-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; margin-bottom: 3rem;">
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Total
                                GMV</span>
                            <div class="value" id="stats-revenue">₹0</div>
                        </div>
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Active
                                Artisans</span>
                            <div class="value" id="stats-weavers">0</div>
                        </div>
                        <div class="stats-tile">
                            <span
                                style="color: #999; font-weight: 600; font-size: 0.9rem; text-transform: uppercase;">Collection
                                Size</span>
                            <div class="value" id="stats-sarees">0</div>
                        </div>
                    </div>

                    <div class="analytics-grid">
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.4rem; margin-bottom: 1rem;">
                                Revenue by Category</h3>
                            <div class="chart-wrapper">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.4rem; margin-bottom: 1rem;">Recent
                                Activity</h3>
                            <div id="recent-activity-list" class="activity-list-scroll"></div>
                        </div>
                    </div>

                    <div style="margin-top: 3rem;">
                        <div class="chart-container">
                            <h3 style="font-family: var(--font-heading); font-size: 1.4rem; margin-bottom: 1rem;">Top
                                Performing Artisans</h3>
                            <div style="overflow-x: auto; flex: 1;" class="activity-list-scroll">
                                <table class="data-table" id="top-weavers-table">
                                    <thead>
                                        <tr>
                                            <th>Artisan</th>
                                            <th>Region</th>
                                            <th>Total Sales</th>
                                            <th>Revenue</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="top-weavers-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="footer-placeholder" style="margin-top: 5rem;"></div>
            </div>
        </main>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/components.js"></script>
    <script>
        (async function () {
            const user = await auth.checkAuth();
            if (!user || user.role !== 'admin') {
                window.location.href = '/pages/login.html';
                return;
            }

            try {
                const response = await api.get('/api/admin/analytics');
                const data = response.data;

                if (!data) {
                    throw new Error('No analytics data received');
                }

                document.getElementById('loading-state').style.display = 'none';
                const content = document.getElementById('analytics-content');
                content.style.display = 'block';

                // Update Stats
                const stats = {
                    revenue: (data.categoryBreakdown || []).reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0),
                    weavers: (data.topWeavers || []).length,
                    sarees: (data.categoryBreakdown || []).reduce((sum, item) => sum + (parseInt(item.saree_count) || 0), 0)
                };

                document.getElementById('stats-revenue').textContent = `₹${stats.revenue.toLocaleString('en-IN')}`;
                document.getElementById('stats-weavers').textContent = stats.weavers;
                document.getElementById('stats-sarees').textContent = stats.sarees;

                // Category Chart
                const chartEl = document.getElementById('category-chart');
                if (chartEl && data.categoryBreakdown && data.categoryBreakdown.length > 0) {
                    const ctx = chartEl.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.categoryBreakdown.map(c => c.name),
                            datasets: [{
                                data: data.categoryBreakdown.map(c => c.revenue),
                                backgroundColor: ['#8B4513', '#D4930A', '#2C3E50', '#7F8C8D', '#E67E22', '#16A085'],
                                borderWidth: 0,
                                hoverOffset: 20
                            }]
                        },
                        options: {
                            plugins: {
                                legend: { position: 'bottom', labels: { padding: 25, usePointStyle: true, font: { family: 'Poppins', size: 12 } } }
                            },
                            cutout: '70%',
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                } else if (chartEl) {
                    chartEl.parentElement.innerHTML += '<p style="text-align:center;color:#999;padding:2rem;">No category data available</p>';
                }

                // Recent Activity
                const activityList = document.getElementById('recent-activity-list');
                const activities = data.recentActivity || [];
                if (activities.length > 0) {
                    activityList.innerHTML = activities.map(act => `
                        <div class="activity-card">
                            <div>
                                <div style="font-weight: 700; color: var(--color-dark);">Order #${act.id}</div>
                                <div style="font-size: 0.85rem; color: #999;">${new Date(act.created_at).toLocaleDateString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 800; color: var(--color-primary);">₹${parseFloat(act.total_amount || 0).toLocaleString('en-IN')}</div>
                                <span class="status-badge status-${act.status || 'pending'}">${act.status || 'pending'}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    activityList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">No recent orders</p>';
                }

                // Top Weavers
                const weaversBody = document.getElementById('top-weavers-body');
                const weavers = data.topWeavers || [];
                if (weavers.length > 0) {
                    weaversBody.innerHTML = weavers.slice(0, 5).map(w => `
                        <tr>
                            <td style="font-weight: 700;">${w.name}</td>
                            <td>${w.region || 'Unknown'}</td>
                            <td>${w.order_count} Orders</td>
                            <td style="font-weight: 800; color: var(--color-primary);">₹${parseFloat(w.total_earnings || 0).toLocaleString('en-IN')}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="window.location.href='/pages/admin-users.html?id=${w.id}'">View Detail</button></td>
                        </tr>
                    `).join('');
                } else {
                    weaversBody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2rem;color:#999;">No weaver data available</td></tr>';
                }

            } catch (err) {
                console.error('Analytics load error:', err);
                document.getElementById('loading-state').innerHTML = `
                    <div style="color: var(--color-light-red); padding: 2rem;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-bottom:1rem;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <h3 style="margin-bottom:0.5rem;">Marketplace Intelligence Offline</h3>
                        <p style="color:#666;">${err.message || 'Unable to retrieve data at this time.'}</p>
                        <button class="btn btn-primary" style="margin-top:1.5rem;" onclick="location.reload()">Try Again</button>
                    </div>
                `;
                notifications.showToast('error', 'Sync Failed', 'Unable to retrieve marketplace intelligence.');
            }
        })();
    </script>
</body>

</html>